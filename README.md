

### 인프런 스프링 고급편 강의 예제 파일


# [스프링] 2. ThreadLocal

## 동시성 문제

동시에 여러 사용자가 요청하면 여러 쓰레드가 동시에 애플리케이션 로직을 호출할 경우

**싱글톤으로 등록된 스프링빈의 경우 객체의 인스턴스가 애플리케이션에 1개만 존**재하게 된다.

하나만 있는 인스턴스의 필드를 여러 쓰레드가 동시에 접근하게되면  저장한 데이터와 조회한 데이터가 다른 문제가 발생한다.

이처럼 **여러 쓰레드가 동시에 같은 인스턴스의 필드 값을 변경하면서 발생하는 문제를 동시성 문제**라 한다.

스프링 빈 처럼 싱글톤 객체의 필드를 변경하며 사용할 때 이러한 동시성 문제를 조심해야 한다.

동시성 문제는 지역 변수에서는 발생하지 않는다.

지역 변수는 쓰레드마다 각각 다른 메모리 영역이 할당

동시성 문제가 발생하는 곳은 같은 인스턴스의 필드(주로 싱글톤), 또는 static 같은 공용 필드에 접근 할 때 발생한다.

동시성 문제는 값을 읽기만 하면 발생하지 않는다.

어디선가 값을 변경하기 때문에 발생한다.

```java

@Bean
public class Example {

//여러 스레드가 동시에 접근해 값을 변경할 경우 조회한 데이터와 저장한 데이터가 다른 문제가 발생할 수 있다.
private Long amount; 

	public void plusAmount() {
			amount += 10;
	}

	public void minusAmount() {
			amount -= 10;
	}

	public Long getAmount() {
		return amount;
	}

}

```

### 쓰레드 로컬

**************************************************동시성 문제를 ThreadLocal을 통해 해결**************************************************

쓰레드 로컬을 사용하면 각 쓰레드마다 별도의 내부 저장소를 제공한다.

따라서 같은 인스턴스의 쓰레드 로컬 필드에 접근해도 문제 없다.

쓰레드 로컬을 모두 사용하고 나면 ThreadLocal.remove()를 호출해서 쓰레드 로컬에 저장된 값을 제거해 주어야한다.

쓰레드 로컬의 값을 사용 후 제거하지 않고 그냥 두면 WAS(톰캣)처럼 쓰레드 풀을 사용하는 경우에 심각한 문제가 발생 할 수 있다.

쓰레드 로컬의 값을 제거하지 않으면 다른 요청에 의해 쓰레드가 재할당 되었을때 쓰레드 로컬에 값이 남아있게 되어 문제가 일어난다!